# ----------------------------------------------------------------------------
# TMUX Configuration
# ----------------------------------------------------------------------------
# This configuration is designed to work universally across both local and
# remote (SSH) environments. All settings are applied globally to ensure
# a consistent tmux experience regardless of where the session is running.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# TMUX Plugin Manager (TPM) Setup
# ----------------------------------------------------------------------------

# Auto-install TPM if not present and reload config
if-shell '[ ! -d "$HOME/.tmux/plugins/tpm" ]' \
  "run-shell 'git clone https://github.com/tmux-plugins/tpm $HOME/.tmux/plugins/tpm && tmux source-file ~/.tmux.conf'"

# TPM plugins directory
set -g @tpm_plugins_dir ~/.tmux/plugins

# ----------------------------------------------------------------------------
# Terminal & Shell Configuration
# ----------------------------------------------------------------------------

# Terminal and shell defaults
set -g default-terminal "screen-256color"
set-option -g default-shell $SHELL
set-option -g default-command "$SHELL -i"
set -ga update-environment 'TERM'

# Terminal features
set -g mouse on                     # Enable mouse mode (tmux 2.1 and above)
set-option -g focus-events on       # Enable focus events
set-option -g escape-time 10        # Time to wait for escape sequences (ms)

# ----------------------------------------------------------------------------
# Clipboard Settings
# ----------------------------------------------------------------------------

# Enable clipboard forwarding for nested tmux sessions (local -> SSH -> remote)
# Allows remote tmux sessions to copy to local clipboard via OSC 52 protocol
set -g set-clipboard on
set -g assume-paste-time 10
set -as terminal-overrides ',*:Ms=\E]52;%p1%s;%p2%s\007'
set -ga terminal-overrides '*:Ss=\E]52;%p1%s;%p2%s\007'
set -ga terminal-overrides '*:Cs=\E]52;%p1%s;%p2%s\007'

# ----------------------------------------------------------------------------
# Window & Pane Configuration
# ----------------------------------------------------------------------------

# Window and pane indexing (start at 1 instead of 0)
set -g base-index 1
setw -g pane-base-index 1

# Window title and renaming
set -g set-titles on
set -g set-titles-string '#S: #I - #W'                    # Format: Session: WindowIndex - WindowName
set -g renumber-windows on                                # Auto-renumber when windows close
set -g automatic-rename on                                # Auto-rename based on active program
set -g automatic-rename-format "#{pane_current_command}"  # Use current command as window name

# Pane border styling
set -g pane-active-border-style fg=red     # Active pane border (matches choose-tree)
set -g pane-border-style fg=colour235      # Inactive pane border (darker grey)
set -g pane-border-lines heavy             # Use heavy border lines for visibility
set -g pane-border-format "#[fg=colour110] #{pane_index} #[fg=colour244]> #[fg=colour180]#{pane_current_command} "

# Optimized pane border status (only update when pane count changes)
set-hook -g window-pane-changed '
  if-shell "[ #{window_panes} -gt 1 ]" \
    "set-window-option pane-border-status top" \
    "set-window-option pane-border-status off"'

# Mode style for choose-tree selection bar
# Dark greyish background with soft yellow text for selected items
set -g mode-style bg=colour238,fg=colour180

# ----------------------------------------------------------------------------
# Status Bar Configuration
# ----------------------------------------------------------------------------

# Status line settings
set -g status on
set -g status-interval 10                                 # Update every 10 seconds (reduced overhead)
set -g status-justify left                                # Left-align windows in status bar

# Activity monitoring
set -g monitor-activity on                                # Monitor for activity in windows
set -g visual-activity on                                # Show visual indicator on activity

# ----------------------------------------------------------------------------
# Local Specific Configuration
# ----------------------------------------------------------------------------

# Configuration applied only on local tmux session
# - status-position top: Position status bar at bottom (better for SSH/remote use)
if-shell '[ -z "$SSH_CLIENT" ] && [ -z "$SSH_CONNECTION" ]' \
  "set -g status-position top"

# ----------------------------------------------------------------------------
# Theme Configuration
# ----------------------------------------------------------------------------

set -g @plugin 'odedlaz/tmux-onedark-theme'
set -g @onedark_theme 'true'

# Time and date format with colors
set -g @onedark_time_format "#[fg=brightyellow]%I:%M %p"  # 12-hour format in yellow
set -g @onedark_date_format "#[fg=brightgreen]%d/%m/%Y"    # Date format in green

# Custom status bar widgets
set -g @onedark_widgets "#[fg=brightred] #(whoami) "      # Display current username

# ----------------------------------------------------------------------------
# Key Bindings
# ----------------------------------------------------------------------------

# Word deletion and navigation
bind -n M-Delete send-keys M-Backspace                  # Alt+Delete deletes entire word
bind -n M-Left send-keys M-b                            # Alt+Left moves word backward
bind -n M-Right send-keys M-f                           # Alt+Right moves word forward

# Session management
bind S command-prompt -p "Session name:" \
  "new-session -s '%%' -c '#{pane_current_path}'"       # Create new session with prompt
bind s choose-tree -w -F '#{?pane_format,#[fg=colour36]#{pane_current_command} #[fg=colour109]#{pane_title:0:15}...,#{?window_format,#[fg=colour113]#{window_name}#{window_flags} #[fg=colour3](#{window_panes} panes), #[fg=colour3]#{(#{session_windows} windows)}#[fg=colour146]#{?session_grouped,(group #{session_group}: #{session_group_list}),}#[fg=colour167] (#{t:session_created})#{?session_attached,#[fg=colour146] (attached),#[fg=colour146] (unattached)}}}'
bind l lock-session                                      # Lock current session

# Window management
bind-key r command-prompt -I "#W" "rename-window '%%'"  # Rename current window

# Pane management
bind m resize-pane -Z                                    # Toggle pane zoom
bind - split-window -v -c "#{pane_current_path}"         # Vertical split (current dir)
bind | split-window -h -c "#{pane_current_path}"         # Horizontal split (current dir)

# Prefix forwarding and status bar
bind-key C-b send-prefix                                 # Forward Ctrl-b to nested tmux/SSH
bind-key M-s set-option status                           # Toggle status bar (Alt+s)

# Smart Ctrl+D: Exit SSH session or close pane
# Detects SSH in process tree (works with nested tmux sessions)
bind-key -n C-d if-shell '[ "#{pane_current_command}" = "ssh" ]' \
  'send-keys "tmux detach-client" C-m; run-shell "sleep 0.5; tmux send-keys -t #{pane_id} C-d"' \
  "send-keys C-d"

# ----------------------------------------------------------------------------
# Plugins
# ----------------------------------------------------------------------------

# Core plugins (always loaded)
set -g @plugin 'tmux-plugins/tpm'                   # Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tmux-sensible'         # Sensible tmux defaults
set -g @plugin 'tmux-plugins/tmux-resurrect'        # Save and restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'        # Automatic session backup
set -g @plugin 'tmux-plugins/tmux-prefix-highlight' # Highlight prefix key usage
set -g @plugin 'tmux-plugins/tmux-pain-control'     # Enhanced pane management
set -g @plugin 'tmux-plugins/tmux-copycat'          # Enhanced search capabilities
set -g @plugin 'christoomey/vim-tmux-navigator'     # Vim-like pane navigation
set -g @plugin 'tmux-plugins/tmux-yank'             # Copy text to system clipboard

# Resurrect plugin configuration
set -g @resurrect-strategy 'pane'                                          # Save strategy: session-level
set -g @resurrect-processes 'ssh btop node python lein clojure java "podman logs"'  # Processes to restore
set -g @resurrect-save-plugin-vars 'on'                                    # Save plugin variables
set -g history-limit 100000                                                # Command history limit

# Continuum plugin configuration
set -g @continuum-boot 'on'            # Auto-boot last session on tmux start
set -g @continuum-save-interval '5'    # Auto-save interval (minutes)
set -g @continuum-restore 'on'         # Auto-restore last session on startup

# Yank plugin configuration
# OSC 52 terminal-overrides enable clipboard forwarding through SSH and nested tmux
set -g @yank_selection 'clipboard'

# Prefix highlight plugin configuration
set -g @prefix_highlight_show_copy_mode 'on'                           # Show copy mode indicator
set -g @prefix_highlight_show_sync_mode 'on'                           # Show sync mode indicator
set -g @prefix_highlight_sync_mode_attr 'fg=red,bold'                  # Sync mode color
set -g @prefix_highlight_copy_mode_attr 'fg=yellow,bold'               # Copy mode color

# ----------------------------------------------------------------------------
# Additional Configuration
# ----------------------------------------------------------------------------

# Load local config override if it exists
if-shell '[ -f ~/.tmux_local.conf ]' "source-file ~/.tmux_local.conf"

# ----------------------------------------------------------------------------
# Initialize TPM Plugins (Keep at the bottom)
# ----------------------------------------------------------------------------

# Auto-install plugins on first load (creates marker file after installation)
if-shell '[ ! -f "$HOME/.tmux/plugins/.plugins_installed" ]' \
  "run-shell '$HOME/.tmux/plugins/tpm/bin/install_plugins && touch $HOME/.tmux/plugins/.plugins_installed'"

# Initialize TPM (must be last)
run '~/.tmux/plugins/tpm/tpm'
